<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Managing multi-cluster secrets with Sealed Secrets - MSbarbieri Blog</title><meta name=Description content="Personal tech blog"><meta property="og:title" content="Managing multi-cluster secrets with Sealed Secrets"><meta property="og:description" content="One of the most hard problems i have found dealing with multiple-cluster in my jobs is dealing with secrets management, create secrets for each cluster, being sure that secret works, and store them safely.
Having a proper control of this issue always be a big mess, mostly because this easily become a safety issue most of the time in companies i have passed, someone have all the secrets stored in their machine or in some dark and scared place, or all of the secrets start to be stored in one private repository where every one in a point of the time will have the access or other horrible solution like that."><meta property="og:type" content="article"><meta property="og:url" content="https://www.msbarbieri.dev/sealled-secrets/"><meta property="og:image" content="https://www.msbarbieri.dev/icon.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-04T18:00:38-03:00"><meta property="article:modified_time" content="2023-01-08T17:36:33-03:00"><meta property="og:site_name" content="Matheus barbieri"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.msbarbieri.dev/icon.jpg"><meta name=twitter:title content="Managing multi-cluster secrets with Sealed Secrets"><meta name=twitter:description content="One of the most hard problems i have found dealing with multiple-cluster in my jobs is dealing with secrets management, create secrets for each cluster, being sure that secret works, and store them safely.
Having a proper control of this issue always be a big mess, mostly because this easily become a safety issue most of the time in companies i have passed, someone have all the secrets stored in their machine or in some dark and scared place, or all of the secrets start to be stored in one private repository where every one in a point of the time will have the access or other horrible solution like that."><meta name=application-name content="Matheus Barbieri"><meta name=apple-mobile-web-app-title content="Matheus Barbieri"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.msbarbieri.dev/sealled-secrets/><link rel=next href=https://www.msbarbieri.dev/argo-application-set/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Managing multi-cluster secrets with Sealed Secrets","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.msbarbieri.dev\/sealled-secrets\/"},"genre":"posts","wordcount":513,"url":"https:\/\/www.msbarbieri.dev\/sealled-secrets\/","datePublished":"2022-05-04T18:00:38-03:00","dateModified":"2023-01-08T17:36:33-03:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"matheus barbieri"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="MSbarbieri Blog">Matheus Barbieri</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/wiki/>wiki </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/msbarbieri/msbarbieri.github.io title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw" aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="MSbarbieri Blog">Matheus Barbieri</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/wiki/ title>wiki</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/msbarbieri/msbarbieri.github.io title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Managing multi-cluster secrets with Sealed Secrets</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://www.msbarbieri.dev title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>matheus barbieri</a></span>&nbsp;<span class=post-category>included in <a href=/categories/gitops/><i class="far fa-folder fa-fw" aria-hidden=true></i>GitOps</a>&nbsp;<a href=/categories/security/><i class="far fa-folder fa-fw" aria-hidden=true></i>Security</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-05-04>2022-05-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;513 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;3 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#installing>Installing</a><ul><li><a href=#installing-sealed-secrets>Installing sealed secrets</a></li><li><a href=#installing-cli>Installing cli</a></li></ul></li><li><a href=#how-to>How To</a><ul><li><a href=#creating-a--new-secret>Creating a new secret</a></li><li><a href=#applying-sealed-secret>Applying sealed secret</a></li></ul></li><li><a href=#certificate-management>Certificate Management</a><ul><li><a href=#adding-a-new-cert>adding a new cert</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>One of the most hard problems i have found dealing with multiple-cluster in my jobs is dealing with secrets management, create secrets for each cluster, being sure that secret works, and store them safely.</p><p>Having a proper control of this issue always be a big mess, mostly because this easily become a safety issue
most of the time in companies i have passed, someone have all the secrets stored in their machine or in some dark and scared place, or all of the secrets start to be stored in one private repository where every one in a point of the time will have the access or other horrible solution like that.</p><p>In my researches about developer experience i have found some people talking about one open-source project called Sealed Secrets and in the moment i looked for it, i instantly fall in love.</p><p>The concept is really simple and powerful i an application focused on kubernetes, which receive some data and encrypt it and transform into an k8s custom resource.</p><p>At first you may think &ldquo;why do i need this, i can only place my secret in my cluster right?&rdquo;
well yes, but when we start to create custom pipelines to improve our deployment process, create multiple clusters, or increase a lot our internal applications, store this secrets and apply them again become a real problem.</p><p>With sealed secrets we can create the secret based on a specific certificate, and store them anywhere we want, and in the moment we apply that sealed-secret the service will generate the real secret.</p><h2 id=installing>Installing</h2><h3 id=installing-sealed-secrets>Installing sealed secrets</h3><pre tabindex=0><code>kubectl create namespace sealed-secrets
helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
helm install sealed-secrets sealed-secrets/sealed-secrets --namespace sealed-secrets --version 2.1.8
</code></pre><h3 id=installing-cli>Installing cli</h3><p>Enter on <a href=https://github.com/bitnami-labs/sealed-secrets/releases/tag/v0.17.5 target=_blank rel="noopener noreffer">Release URL</a> and download the version for your machine, in my case will be linux-amd64, here we will do this using wget.</p><pre tabindex=0><code>wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.17.5/kubeseal-0.17.5-linux-amd64.tar.gz
tar -xzf kubeseal-0.17.5-linux-amd64.tar.gz
sudo mv kubeseal /usr/local/bin/
</code></pre><h2 id=how-to>How To</h2><h3 id=creating-a--new-secret>Creating a new secret</h3><h4 id=key-value-secret>Key Value Secret</h4><pre tabindex=0><code>kubectl create secret generic &lt;YOUR_SECRET&gt; --dry-run=client --from-literal=&lt;KEY&gt;=&lt;VALUE&gt; -o yaml | \
    kubeseal \
      --controller-name=sealed-secrets \
      --controller-namespace=sealed-secrets \
      --format yaml &gt; &lt;SEALED_SECRET_FILE&gt;.yaml
</code></pre><h4 id=file-secret>File Secret</h4><pre tabindex=0><code>kubectl create secret generic &lt;YOUR_SECRET&gt; --dry-run=client --from-file=&lt;FILE&gt; -o yaml | \
    kubeseal \
      --controller-name=sealed-secrets \
      --controller-namespace=sealed-secrets \
      --format yaml &gt; &lt;SEALED_SECRET_FILE&gt;.yaml
</code></pre><h3 id=applying-sealed-secret>Applying sealed secret</h3><pre tabindex=0><code>kubectl create -f &lt;SEALED_SECRET_FILE&gt;.yaml
</code></pre><h2 id=certificate-management>Certificate Management</h2><p>The sealed secret controller with generate certificates when is deployed, and will generate new certificate at some period of time, but you can add your own certificates.</p><blockquote><p>ℹ️ when a new certificate is added, the old ones isn&rsquo;t deleted, so old generated sealed secrets can be added again if you have the cert applied.</p></blockquote><h3 id=adding-a-new-cert>adding a new cert</h3><pre tabindex=0><code>kubectl -n sealed-secrets create secret tls &lt;CERT_NAME&gt; --cert=&lt;PUBLIC_KEY_FILE&gt; --key=&lt;PRIVATE_KEY_FILE&gt;
kubectl -n sealed-secrets label secret &lt;CERT_NAME&gt; sealedsecrets.bitnami.com/sealed-secrets-key=active
</code></pre><p>after that restart the sealed secrets controller pod, and you are good to go, now you can get all the encrypted secrets you created and can put into a repository without fear.</p><p>This are the first steps to deal with sealed secrets, if you want to understand more about what Sealed Secrets really works i recommended you to follow the <a href=https://github.com/bitnami-labs/sealed-secrets target=_blank rel="noopener noreffer">Project Repository</a>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-08&nbsp;<a class=git-hash href=https://github.com/msbarbieri/msbarbieri.github.io/commit/ef4d6504205e0460b4ad04d3f6859dc14090a773 target=_blank title="commit by MSBarbieri(matheussouzabarbieri@gmail.com) ef4d6504205e0460b4ad04d3f6859dc14090a773: move content">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>ef4d650</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/sealled-secrets/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/argo-application-set/ class=next rel=next title="Automate Delivery specification with ArgoCD ApplicationSet">Automate Delivery specification with ArgoCD ApplicationSet<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.96.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://www.msbarbieri.dev target=_blank>matheus barbieri</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>